<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <script src="https://code.jquery.com/jquery-1.10.2.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.js"></script>
  <!-- <script src="https://d3js.org/d3.v3.js"></script> -->
  <!-- <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jsnetworkx/0.3.4/jsnetworkx.js"></script> -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/vis/4.21.0/vis.min.css" rel="stylesheet" type="text/css" />
    
<style>

.scrollbar {
/*margin-left: 30px;*/
float: left;
height: 225px;
/*width: 65px;*/
background: #fff;
overflow-y: scroll;
margin-bottom: 25px;
}

.force-overflow {
min-width: 400px;
min-height: 225px;
}

.scrollbar-primary::-webkit-scrollbar {
/*width: 12px;*/
background-color: #F5F5F5; }

.scrollbar-primary::-webkit-scrollbar-thumb {
border-radius: 10px;
-webkit-box-shadow: inset 0 0 6px rgba(0, 0, 0, 0.1);
background-color: #A0A0A0; }

ul {
  list-style: square;
  margin: 0;
  padding: 0;
  overflow: hidden;
  background-color: #333;
  font-family: "Verdana"
  min-width: 400px;
}

#mynetwork {
  height: 400px;
  border: 2px solid #eae7e6;
  background-color: #eae7e6;
  border-radius: 15px;
}

.live__scroll {
  overflow-x: auto;
  overflow-y: hidden;
  white-space: nowrap;
}


ul .nav {
  list-style-type: none;
  margin: 0;
  padding: 0;
  overflow: hidden;
  background-color: #333;
  font-family: "Verdana";
  float: left;
}

li a .nav{
  display: block;
  color: white;
  text-align: center;
  padding: 14px 30px;
  text-decoration: none;
}

/*li a:hover:not(.active) .nav {
  background-color: #C0C0C0;
}*/

li a {
  display: block;
  color: white;
  text-align: center;
  /*padding: 14px 30px;*/
  text-decoration: none
}

li:hover, li:focus {
  background-color: #ffffff;
  padding: 5px;
  opacity: 0.72;
}

.active {
  background-color: #C0C0C0;
}

body {
  background-repeat: no-repeat;
  background-size: 2000px 1000px;
}

</style>
</head>
<body onload="pickFirstNode()">
<ul class="nav">
  <li class="nav"><a href="home.html">Home</a></li>
</ul>
<div class="container-fluid">    
  <div class="row">
    <div class="col-sm-6">
      <br/>
      <div style= "border-radius: 15px; background-color: #eae7e6; padding: 10px; font-family: 'Verdana'"> 
        <div> Please provide feedback for the node picked. Select "yes" if there is an anomaly otherwise select "no".</div><br/>
        <center>
        <div id="feedback">
          <input type="radio" id="r1" name="rate" value=1 checked="checked"> YES
          <input type="radio" id="r2" name="rate" value=0> NO
        </div>
        <br/>
        <div id="feedback_response">

        </div> 
        </center>
        <br/>

        <div> Get the next node by clicking the button below. This picks a node from a cluster for which feedback needs to be given. The attributes for the node will be listed along with the node.<br/>
        To stop the algorithm and find out the anomalies generated so far, click on "Stop Algorithm"</div><br/>
        <center><button class="btn btn-lg btn-success" value="start" data-toggle= "tooltip" title="Pick a node" onclick="pickNode()">Next Node</button>
        <a href="display.html"> 
          <span style="background-color: white ">
          <i class="fa fa-hand-paper-o" aria-hidden="true"></i>
          <input type="button" class="btn btn-danger btn-lg" value="Stop Algorithm" data-toggle= "tooltip" title="Stop the algorithm to display the anomalies generated">

          </input>
          </span>
        </a>
        </center><br/>
        
        </div>
        <br/> 

        <div id="node_div" style= "border-radius: 15px; background-color: #eae7e6; padding: 10px; font-family: 'Verdana'">
          <label name="pickedNodeLabel"></label><br/>
          <div class="live__scroll">
            <table class="table table-hover" id="node_table">
          </table>
          </div>
        </div> <br/>

        <div style="float: left; font-family: 'Verdana'; border-radius: 15px; width: 700px" class="scrollbar scrollbar-primary">
          <div style="border-radius: 15px; background-color: #eae7e6; padding: 30px;" class="force-overflow">
              <label style="font-family: 'Verdana';">Reviews</label>
              <div id="reviews"></div>
              <!-- <ul id="reviews" style="background-color: #eae7e6;">
              </ul> -->
          </div>
        </div>
      </div>

    <div class="col-sm-6">
      <br/>
      <div style = "border-radius: 15px; background-color: #eae7e6; padding: 10px; font-family: 'Verdana'">
      <div> The neighbourhood cluster for the picked node is shown here</div><br/>
      <br/>
      </div>
      <br/>
      <div id="mynetwork"></div><br/>
      <div style="float: left; font-family: 'Verdana'; border-radius: 15px; height: 170px; width: 700px" class="scrollbar scrollbar-primary">
          <div style="border-radius: 15px; background-color: #eae7e6; padding: 30px;" class="force-overflow">
              <label style="font-family: 'Verdana';">Neighbor Review</label>
              <div id="neighborhood_review"></div>
              <!-- <ul id="reviews" style="background-color: #eae7e6;">
              </ul> -->
          </div>
      </div>
    </div>
  </div>
</div>
    
</body>
<script type="text/javascript">
      var users = {};
      function sendFeedback(){

        var node_label_element = document.getElementsByName("pickedNodeLabel")[0];
        var xhttp = new XMLHttpRequest();
        var url = "http://localhost:5000/api/v1/nodes/feedback/" + node_label_element.id;

        var feedback = "";

        if (document.getElementById("r1").checked) {
          feedback = document.getElementById("r1").value;
        }
        else{
          feedback = document.getElementById("r2").value;
        }

        xhttp.open("POST", url + "?feedback=" + feedback, true);
        xhttp.send();
      }

      function clearContents(){

        document.getElementById("feedback_response").innerHTML = "";
      }

      function populateUsers(){
        $.ajax({
        url: "http://localhost:5000/api/v1/users",
        dataType: "json",
        success: function (data) {
            users = data;
        }})

      }

      function pickFirstNode(){
        populateUsers();
        var xhttp = new XMLHttpRequest();
        var url = "http://localhost:5000/api/v1/nodes/pick";

        xhttp.onreadystatechange = function() {
          if (this.readyState == 4 && this.status == 200) {
            parsePickNode(this.responseText);
            getNeighbourhood();
          }
        };

        xhttp.open("GET", url, true);
        xhttp.send();
      }

      function pickNode(){

        clearContents();
        sendFeedback();

        var xhttp = new XMLHttpRequest();
        var url = "http://localhost:5000/api/v1/nodes/pick";

        xhttp.onreadystatechange = function() {
          if (this.readyState == 4 && this.status == 200) {
            parsePickNode(this.responseText);
            getNeighbourhood();
          }
        };

        xhttp.open("GET", url, true);
        xhttp.send();

        clearContents();

      }

      function parsePickNode(responseText){
        var temp = JSON.parse(responseText);
          var node_label = temp.data1.node;
          node_label = "NodeID: " + node_label;
          var node_label_element = document.getElementsByName("pickedNodeLabel")[0];
          node_label_element.setAttribute("id", temp.data1.node);

          node_label_element.innerHTML = node_label;

          var node_attributes = temp.data1.attribute.split(" ");
          node_attributes[0] = node_attributes[0].substr(1);
          node_attributes[node_attributes.length - 1] = node_attributes[node_attributes.length - 1].substr(0, node_attributes[node_attributes.length - 1].length - 1);

          node_attributes_cleaned = node_attributes.filter(Boolean) 

          var num_features = node_attributes_cleaned.length;
          var t = num_features / 3;

          count = 0;
          res = "";

          res += "<thead class='thead-dark'>";
          for(i = 0; i < num_features; i++){
            res += "<th class='bg-info'> f" + String(i + 1) + "</th>";
          }
          res +="</thead><tbody><tr>";
            for (j = 0; j < num_features; j++){
              res += "<td>" + node_attributes_cleaned[count] + "</td>" 
              count += 1;
            }

          res += "</tr></tbody>";
          document.getElementById("node_table").innerHTML = res;
          // document.createElement("<ul>");
          reviews = users[temp.data1.user].split("<br/>");
          review_result = "<ol style='background-color: #eae7e6;'>";
          for(i = 0; i<reviews.length - 1; i++){
              review_result += "<li>" + reviews[i] + "</li>" + "<br/>";
          }
          review_result += "</ol>"

          document.getElementById("reviews").innerHTML = review_result;
      }
      
      function getNeighbourhood(){

        var node_label_element = document.getElementsByName("pickedNodeLabel")[0];
        var xhttp = new XMLHttpRequest();
        var url = "http://0.0.0.0:5000/api/v1/nodes/"+ node_label_element.id +"/neighbors";

        xhttp.onreadystatechange = function() {
          if (this.readyState == 4 && this.status == 200) {

            node = this.responseText;
            temp = JSON.parse(node);
            var neighborFeatures = new Object();
            var node_ids = [];
            var ids = [];

            for(k = 0; k < temp.data1.length; k++){
              
              var node_attributes = temp.data1[k].attribute.split(" ");
              node_attributes[0] = node_attributes[0].substr(1);
              node_attributes[node_attributes.length - 1] = node_attributes[node_attributes.length - 1].substr(0, node_attributes[node_attributes.length - 1].length - 1);
              node_attributes_cleaned = node_attributes.filter(Boolean) 
              var num_features = node_attributes_cleaned.length;
              
              // res = '<div class="container"><div class="title">Show content</div><div class="content"><div class="background"></div><div class="infocontainer"><div class="info"> users[temp.data1[k].user] </div></div></div></div>';

              res = "<div style='border-radius: 15px; background-color: #eae7e6; padding: 30px;'>";
              res += users[temp.data1[k].user];
              res += "</div>";
              ids.push(temp.data1[k].user)

              neighborFeatures[temp.data1[k].node] = res; //users[temp.data1[k].user];
              node_ids.push(temp.data1[k].node);
            }
            
            var dataset = [];

            for(i = 0; i < temp.data1.length; i++){
              var data = new Object();

              data["id"] = i + 1;
              data["label"] = i + 1;
              // data["title"] = neighborFeatures[node_ids[i]];

              if(i == 0){
                data["borderWidth"] = 1.5;
                data["shadow"] = {
                  enabled: true,
                  size: 10
                };
                data["color"] = {
                  border: '#1B2631',
                  background: '#F1C40F'
                };
              } else {
                data["borderWidth"] = 1.5;
                data["shadow"] = {
                  enabled: true,
                  size: 10
                };
                data["color"] = {
                  border: '#717D7E',
                  background: '#2E86C1'
                }
              }
              dataset.push(data);
            } 

            var nodes = new vis.DataSet(dataset);
            var edges = [];

            for(i = 1; i < temp.data1.length; i++){
              var egde = new Object();
              egde["from"] = 1;
              egde["to"] = i + 1; 
              edges.push(egde);
            }

            var true_edges = new vis.DataSet(edges);
            var container = document.getElementById('mynetwork');
            
            var data = {
              nodes: nodes,
              edges: true_edges
            };

            var options = {interaction: {hover: true, selectable: true}, layout: {  improvedLayout: false } };
            var network = new vis.Network(container, data, options);

            network.on("click", function (params) {
              if(params.nodes[0] > 0){
                count = 1;
                review = "";
                for(var index in users) {
                  if(count == node_ids[params.nodes[0]]){
                    review = users[index];
                    break;
                  }
                  count += 1;
                }
                reviews = review.split("<br/>");
                review_result = "<ol style='background-color: #eae7e6'>";
                for(i = 0; i<reviews.length - 1; i++){
                    review_result += "<li>" + reviews[i] + "</li>" + "<br/>";
                }
                review_result += "</ul>"
                document.getElementById("neighborhood_review").innerHTML = review_result;
              }              
            });
          }
        };

        xhttp.open("GET", url, true);
        xhttp.send();
      }
</script>
</html>